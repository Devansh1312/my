{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}
{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Plugins css Ends-->
{% endblock %}
{% block title %}Tournament Games{% endblock %}
{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{ breadcrumb.child }}</h3>
                </div>
                <div class="col-6">
                    <ol class="breadcrumb">
                        <button class="btn btn-pill btn-outline-primary-2x ml-auto" data-bs-toggle="modal" data-bs-target="#addTournamentGameModal">
                            Add Tournament Game
                        </button>
                    </ol>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- Tournament Games List (Single Table) -->
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="basic-1">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Tournament Name</th>
                                        <th>Game Number</th>
                                        <th>Assigned User</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for game in tournament_games %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ game.tournament_id__tournament_name }}</td>
                                        <td>{{ game.game_number }}</td>
                                        <td>{{ game.assigned_user_name }}</td>
                                        <td>
                                            {% if game.is_upcoming == 1 %}
                                                {% if game.is_unassigned == 1 %}
                                                    <button class="btn btn-primary" onclick="openUserSearchModal({{ game.id }})">
                                                        Assign User
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-warning" onclick="openUserSearchModal({{ game.id }})">
                                                        Change User
                                                    </button>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-danger">Game Finished</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>                                                           
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Search Modal -->
<div class="modal fade" id="userSearchModal" tabindex="-1" aria-labelledby="userSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userSearchModalLabel">Search and Assign User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="searchPhoneNumber" class="form-control mb-3" placeholder="Search by phone number" onkeyup="searchUsers()">
                <div id="userList" class="list-group">
                    <!-- User list will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>
<script src="{% static 'assets/js/tooltip-init.js' %}"></script>
<script>
    let currentGameId = null;

    function openUserSearchModal(gameId) {
        currentGameId = gameId;
        document.getElementById('userList').innerHTML = ''; // Clear previous results
        fetchUsers();
        new bootstrap.Modal(document.getElementById('userSearchModal')).show();
    }

    async function fetchUsers(phone = '') {
        const response = await fetch(`/api/users/?role_id=5&phone=${phone}`);
        const users = await response.json();
        renderUserList(users);
    }

    function searchUsers() {
        const phone = document.getElementById('searchPhoneNumber').value;
        fetchUsers(phone);
    }

    function renderUserList(users) {
        const userList = document.getElementById('userList');
        userList.innerHTML = ''; // Clear current list
        users.forEach(user => {
            const userItem = document.createElement('a');
            userItem.href = '#';
            userItem.className = 'list-group-item list-group-item-action';
            userItem.textContent = `${user.username} - ${user.phone}`;
            userItem.onclick = () => assignUserToGame(user.id);
            userList.appendChild(userItem);
        });
    }

    async function assignUserToGame(userId) {
        if (!currentGameId) {
            alert('Game ID is not defined.');
            return;
        }

        const response = await fetch(`/api/tournament-games/${currentGameId}/assign-user/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ user_id: userId })
        });

        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert(`Failed to assign user: ${error.error}`);
        }
    }
</script>
{% endblock %}
