{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load sass_tags %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
{% endblock %}

{% block title %}
Tournament Games Stats
{% endblock %}

{% block content %}
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>{{ breadcrumb.child }}</h3>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="display" id="stats-table">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Tournament</th>
                                        <th>Game Number</th>
                                        <th>Team A</th>
                                        <th>Team B</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for game in games %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ game.tournament_id.tournament_name }}</td>
                                        <td>{{ game.game_number }}</td>
                                        <td>{{ game.team_a.team_name }}</td>
                                        <td>{{ game.team_b.team_name }}</td>
                                        <td>
                                            <a href="#" class="btn btn-primary btn-sm edit-stats-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editStatsModal"
                                                data-game-id="{{ game.id }}">
                                                Edit Stats
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Stats Modal -->
<div class="modal fade" id="editStatsModal" tabindex="-1" aria-labelledby="editStatsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="modalContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.edit-stats-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const gameId = this.dataset.gameId;

            // Make an AJAX request to fetch the form
            fetch(`/games/edit/${gameId}/`)
                .then(response => response.json())  // Ensure response is parsed as JSON
                .then(data => {
                    if (data.html) {
                        // Inject the fetched HTML into the modal content div
                        document.getElementById('modalContent').innerHTML = data.html;
                        // Manually trigger the modal to show after content is loaded
                        $('#editStatsModal').modal('show');
                    } else if (data.error) {
                        // Handle errors by showing an alert or error modal
                        alert(data.error);  // You can replace this with your custom error handling
                    }
                })
                .catch(error => {
                    console.error("Error loading the game stats form:", error);
                });
        });
    });

    // Initialize DataTable
    $('#stats-table').DataTable();
});
console.log("Game ID:", gameId);  // Log the game ID to ensure it's correct


</script>
{% endblock %}
